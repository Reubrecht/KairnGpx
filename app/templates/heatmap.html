{% extends "base.html" %}

{% block head %}
<!-- Leaflet & Heatmap -->
<link rel="stylesheet" href="{{ url_for('static', path='/css/leaflet.css') }}" />
<script src="{{ url_for('static', path='/js/leaflet.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<style>
    #map {
        height: calc(100vh - 64px);
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="relative">
    <div id="map" class="z-0"></div>

    <!-- Floating Info Panel -->
    <div
        class="absolute top-4 right-4 z-10 bg-white/90 backdrop-blur-md p-4 rounded-xl shadow-lg border border-slate-200 max-w-xs">
        <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
            üî• Heatmap Kairn
        </h2>
        <p class="text-sm text-slate-600 mt-1">
            Visualisez la densit√© des activit√©s de la communaut√©.
            <br>
            <span class="font-bold text-brand-600">{{ total_tracks }} traces</span> r√©pertori√©es.
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script id="tracks-json" type="application/json">
    {{ tracks_json | safe }}
</script>
<script id="users-json" type="application/json">
    {{ users_json | safe }}
</script>

<script>
    // 1. Initialize Map
    const map = L.map('map').setView([46.603354, 1.888334], 6); // Centered on France

    const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // Parse Data from JSON
    const tracksDataRaw = document.getElementById('tracks-json').textContent;
    const usersDataRaw = document.getElementById('users-json').textContent;
    let tracks = [];
    let users = [];

    try {
        tracks = JSON.parse(tracksDataRaw);
        users = JSON.parse(usersDataRaw);
    } catch (e) {
        console.error("Failed to parse map data", e);
    }

    // 2. Heatmap Layer
    const heatData = tracks.map(t => [t.start_lat, t.start_lon, 0.8]);

    let heatLayer = null;
    if (heatData.length > 0) {
        heatLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 10,
            gradient: { 0.4: 'blue', 0.65: 'lime', 1: 'red' }
        });
        // Default: Add Heatmap
        heatLayer.addTo(map);
    }

    // 3. User Markers Layer
    const userLayer = L.featureGroup();

    users.forEach(u => {
        if (u.location_lat && u.location_lon) {
            let iconHtml = "";
            if (u.profile_picture) {
                iconHtml = `<div class='w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-slate-200'>
                                <img src='${u.profile_picture}' class='w-full h-full object-cover'>
                            </div>`;
            } else {
                let initials = u.username.substring(0, 2).toUpperCase();
                iconHtml = `<div class='w-10 h-10 rounded-full border-2 border-white overflow-hidden shadow-lg bg-brand-600 flex items-center justify-center text-white font-bold text-xs'>
                                ${initials}
                            </div>`;
            }

            const icon = L.divIcon({
                className: 'bg-transparent border-none',
                html: iconHtml,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            const marker = L.marker([u.location_lat, u.location_lon], { icon: icon })
                .bindPopup(`
                    <div class="text-center">
                        <div class="font-bold text-slate-900">${u.username}</div>
                        <div class="text-xs text-slate-500">${u.location_city || ''}</div>
                    </div>
                `);
            userLayer.addLayer(marker);
        }
    });

    // 4. Activity/Track Markers (Circles)
    const trackLayer = L.featureGroup();
    tracks.forEach(t => {
        L.circleMarker([t.start_lat, t.start_lon], {
            radius: 6,
            fillColor: "#10b981",
            color: "#fff",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(trackLayer).bindPopup(`
            <div class="text-center">
                <h3 class="font-bold text-slate-900">${t.title}</h3>
                <p class="text-xs text-slate-500 mb-2">${t.distance_km}km ‚Ä¢ ${t.elevation_gain}m+</p>
                <a href="/track/${t.id}" class="block w-full bg-brand-600 !text-white text-xs font-bold py-1 px-2 rounded hover:bg-brand-700 transition">Voir la trace</a>
            </div>
        `);
    });

    // Default: Add Track Markers
    trackLayer.addTo(map);

    // 5. Layer Control
    const overlays = {
        "Heatmap": heatLayer,
        "Traces (Points)": trackLayer,
        "Membres": userLayer
    };

    // Filter out null layers
    if (!heatLayer) delete overlays["Heatmap"];

    L.control.layers(null, overlays, { position: 'topleft', collapsed: false }).addTo(map);

    // Fit bounds
    if (heatData.length > 0) {
        const group = new L.featureGroup(heatData.map(p => L.marker([p[0], p[1]])));
        map.fitBounds(group.getBounds().pad(0.1));
    }

</script>
{% endblock %}
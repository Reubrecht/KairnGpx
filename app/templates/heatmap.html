{% extends "base.html" %}

{% block head %}
<!-- MapLibre GL JS -->
<script src="{{ url_for('static', path='/js/maplibre-gl.js') }}"></script>
<link href="{{ url_for('static', path='/css/maplibre-gl.css') }}" rel="stylesheet" />
<style>
    #map {
        height: calc(100vh - 64px);
        width: 100%;
    }

    .maplibregl-popup-content {
        padding: 0;
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    /* Custom Scrollbar for side panel if needed */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="relative w-full h-[calc(100vh-64px)]">

    <!-- Map Container -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- Floating Info Panel (Top Left) -->
    <div
        class="absolute top-6 left-6 z-10 bg-white/80 backdrop-blur-xl p-5 rounded-3xl shadow-2xl border border-white/40 ring-1 ring-black/5 max-w-sm transition-all hover:bg-white/95 group">

        <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-black text-slate-800 flex items-center gap-2.5">
                <span
                    class="bg-gradient-to-br from-brand-500 to-brand-600 text-white p-2 rounded-xl shadow-lg shadow-brand-500/20">
                    <i class="ph-bold ph-globe-hemisphere-west"></i>
                </span>
                Kairn Maps
            </h2>
            <div
                class="px-2 py-1 bg-slate-100 rounded-lg text-[10px] font-bold text-slate-500 uppercase tracking-wider">
                Beta
            </div>
        </div>

        <p class="text-xs text-slate-500 leading-relaxed font-medium pl-1">
            Explorez <span class="font-bold text-slate-900">{{ total_tracks }} traces</span> et <span
                class="font-bold text-slate-900">{{ total_events }} événements</span>.
        </p>

        <!-- Legend / Toggles -->
        <div class="mt-5 space-y-3 pt-4 border-t border-slate-100/80">

            <!-- Heatmap Toggle -->
            <label
                class="flex items-center justify-between group/item cursor-pointer p-2 -mx-2 rounded-xl hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center">
                        <i class="ph-fill ph-fire"></i>
                    </div>
                    <div>
                        <span
                            class="block text-sm font-bold text-slate-700 group-hover/item:text-brand-600 transition-colors">Heatmap</span>
                        <span class="block text-[10px] text-slate-400 font-medium">Densité d'activité</span>
                    </div>
                </div>
                <!-- Custom Switch -->
                <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="toggle-heatmap" checked
                        class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-transform duration-200 ease-in checked:translate-x-full checked:border-brand-500" />
                    <div
                        class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer peer-checked:bg-brand-500 transition-colors">
                    </div>
                </div>
            </label>

            <!-- Start Points Toggle -->
            <label
                class="flex items-center justify-between group/item cursor-pointer p-2 -mx-2 rounded-xl hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center">
                        <i class="ph-fill ph-map-pin"></i>
                    </div>
                    <div>
                        <span
                            class="block text-sm font-bold text-slate-700 group-hover/item:text-emerald-600 transition-colors">Traces</span>
                        <span class="block text-[10px] text-slate-400 font-medium">Points de départ</span>
                    </div>
                </div>
                <div class="relative inline-block w-10 h-6 align-middle select-none">
                    <input type="checkbox" id="toggle-points" checked
                        class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-transform duration-200 ease-in checked:translate-x-full checked:border-emerald-500" />
                    <div
                        class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer peer-checked:bg-emerald-500">
                    </div>
                </div>
            </label>

            <!-- Events Toggle -->
            <label
                class="flex items-center justify-between group/item cursor-pointer p-2 -mx-2 rounded-xl hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center">
                        <i class="ph-fill ph-flag-banner"></i>
                    </div>
                    <div>
                        <span
                            class="block text-sm font-bold text-slate-700 group-hover/item:text-orange-600 transition-colors">Événements</span>
                        <span class="block text-[10px] text-slate-400 font-medium">Compétitions à venir</span>
                    </div>
                </div>
                <div class="relative inline-block w-10 h-6 align-middle select-none">
                    <input type="checkbox" id="toggle-events" checked
                        class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-transform duration-200 ease-in checked:translate-x-full checked:border-orange-500" />
                    <div
                        class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer peer-checked:bg-orange-500">
                    </div>
                </div>
            </label>

            <!-- Users Toggle -->
            <label
                class="flex items-center justify-between group/item cursor-pointer p-2 -mx-2 rounded-xl hover:bg-slate-50 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                        <i class="ph-fill ph-users"></i>
                    </div>
                    <div>
                        <span
                            class="block text-sm font-bold text-slate-700 group-hover/item:text-indigo-600 transition-colors">Membres</span>
                        <span class="block text-[10px] text-slate-400 font-medium">Communauté</span>
                    </div>
                </div>
                <div class="relative inline-block w-10 h-6 align-middle select-none">
                    <input type="checkbox" id="toggle-users" checked
                        class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer left-1 top-1 transition-transform duration-200 ease-in checked:translate-x-full checked:border-indigo-500" />
                    <div
                        class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer peer-checked:bg-indigo-500">
                    </div>
                </div>
            </label>
        </div>
    </div>

    <style>
        /* Custom Switch Styles */
        .toggle-checkbox:checked {
            transform: translateX(100%);
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: currentColor;
            /* Requires text-color on parent or setting specific bg */
        }

        /* Fix background colors for specific peers since currentColor is tricky here */
        #toggle-heatmap:checked+.toggle-label {
            background-color: #ef4444;
        }

        /* red-500 */
        #toggle-points:checked+.toggle-label {
            background-color: #10b981;
        }

        /* emerald-500 */
        #toggle-events:checked+.toggle-label {
            background-color: #f97316;
        }

        /* orange-500 */
        #toggle-users:checked+.toggle-label {
            background-color: #6366f1;
        }

        /* indigo-500 */
    </style>

    <!-- Map Controls (Top Right) -->
    <div class="absolute top-4 right-4 z-10 flex flex-col gap-2">
        <div
            class="bg-white/90 backdrop-blur-md border border-slate-200 rounded-lg shadow-sm p-1.5 flex flex-col gap-1.5">
            <button onclick="zoomIn()"
                class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 transition-colors">
                <i class="ph-bold ph-plus"></i>
            </button>
            <button onclick="zoomOut()"
                class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 transition-colors">
                <i class="ph-bold ph-minus"></i>
            </button>
            <div class="h-px bg-slate-200 mx-1"></div>
            <button onclick="toggle3D()" id="btn-3d"
                class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 hover:text-brand-600 transition-colors font-black text-[10px]"
                title="Basculer 3D">
                3D
            </button>
            <button onclick="toggleSat()" id="btn-sat"
                class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 hover:text-brand-600 transition-colors"
                title="Satellite">
                <i class="ph-bold ph-globe-hemisphere-east"></i>
            </button>
        </div>
    </div>

    <!-- Loading Indicator (Hidden by default) -->
    <div id="loading-indicator"
        class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-xl flex items-center gap-3">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-brand-600"></div>
        <span class="text-xs font-bold text-slate-700">Chargement de la trace...</span>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script id="tracks-json" type="application/json">
    {{ tracks_json | safe }}
</script>
<script id="users-json" type="application/json">
    {{ users_json | safe }}
</script>
<script id="events-json" type="application/json">
    {{ events_json | safe }}
</script>


<script>
    // Robust Data Parsing
    let tracksRaw = [];
    let usersRaw = [];
    let eventsRaw = [];
    try {
        const tracksEl = document.getElementById('tracks-json');
        const usersEl = document.getElementById('users-json');
        const eventsEl = document.getElementById('events-json');
        if (tracksEl && tracksEl.textContent) tracksRaw = JSON.parse(tracksEl.textContent);
        if (usersEl && usersEl.textContent) usersRaw = JSON.parse(usersEl.textContent);
        if (eventsEl && eventsEl.textContent) eventsRaw = JSON.parse(eventsEl.textContent);
    } catch (e) {
        console.error("Data parsing error:", e);
    }

    // Check MapLibre Availability
    if (typeof maplibregl === 'undefined') {
        console.error("MapLibre GL JS not loaded.");
        document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-red-500 font-bold">Erreur de chargement de la carte (librairie manquante).</div>';
    } else {

        // Convert to GeoJSON FeatureCollection
        const tracksGeoJSON = {
            "type": "FeatureCollection",
            "features": tracksRaw
                .filter(t => t.start_lat != null && t.start_lon != null)
                .map(t => ({
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [t.start_lon, t.start_lat]
                    },
                    "properties": {
                        "id": t.id,
                        "title": t.title,
                        "distance": t.distance_km,
                        "elevation": t.elevation_gain,
                        "mag": 1 // For heatmap weight
                    }
                }))
        };

        // Global State
        let hoveredTrackId = null;
        let currentPopup = null; // Track current popup to remove it
        let is3D = false;
        let isSat = false;

        // --- Map Initialization ---
        const map = new maplibregl.Map({
            container: 'map',
            style: '/static/style.json', // Local style
            center: [2.2137, 46.2276], // Default France center (fallback)
            zoom: 5.5,
            pitch: 0,
            bearing: 0,
            antialias: true
        });

        // Geolocation: Center on user
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                // Fly to user location
                map.flyTo({
                    center: [longitude, latitude],
                    zoom: 9, // Closer zoom when located
                    essential: true
                });
            }, error => {
                console.warn("Geolocation access denied or failed:", error);
                // Fallback: Fit bounds of all tracks if no geo (or just keep default France)
                // Existing logic below handles fitBounds if we want:
                fitBoundsToTracks();
            });
        } else {
            fitBoundsToTracks();
        }

        function fitBoundsToTracks() {
            if (tracksRaw && tracksRaw.length > 0) {
                const bounds = new maplibregl.LngLatBounds();
                let hasValidCoords = false;
                tracksRaw.forEach(t => {
                    if (t.start_lat != null && t.start_lon != null) {
                        bounds.extend([t.start_lon, t.start_lat]);
                        hasValidCoords = true;
                    }
                });
                if (hasValidCoords) {
                    map.fitBounds(bounds, { padding: 80, maxZoom: 12, animate: true });
                }
            }
        }

        map.on('load', () => {
            console.log("Map Loaded.");
            try {
                // --- Sources ---

                // 1. Tracks Source (Points)
                map.addSource('tracks', {
                    type: 'geojson',
                    data: tracksGeoJSON,
                    cluster: true,
                    clusterMaxZoom: 9, // Changed from 12 to 9 to show points earlier
                    clusterRadius: 50
                });

                // 2. Heatmap Source
                map.addSource('heatmap-source', {
                    type: 'geojson',
                    data: tracksGeoJSON
                });

                // 3. Hover Track Source
                map.addSource('hover-track', {
                    type: 'geojson',
                    data: { "type": "FeatureCollection", "features": [] }
                });

                // --- Layers ---

                // A. Heatmap Layer
                map.addLayer({
                    id: 'heatmap-layer',
                    type: 'heatmap',
                    source: 'heatmap-source',
                    maxzoom: 15,
                    paint: {
                        'heatmap-weight': ['interpolate', ['linear'], ['get', 'mag'], 0, 0, 6, 1],
                        'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 9, 3],
                        'heatmap-color': [
                            'interpolate', ['linear'], ['heatmap-density'],
                            0, 'rgba(33,102,172,0)',
                            0.2, 'rgb(103,169,207)',
                            0.4, 'rgb(209,229,240)',
                            0.6, 'rgb(253,219,199)',
                            0.8, 'rgb(239,138,98)',
                            1, 'rgb(178,24,43)'
                        ],
                        'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 2, 9, 20],
                        'heatmap-opacity': ['interpolate', ['linear'], ['zoom'], 7, 1, 12, 0.5],
                    }
                });

                // B. Track Line Layer (Hover)
                map.addLayer({
                    id: 'hover-track-line',
                    type: 'line',
                    source: 'hover-track',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#fc4c02',
                        'line-width': 4,
                        'line-opacity': 0.8
                    }
                });

                // C. Circle Layer (Individual Points)
                map.addLayer({
                    id: 'track-points',
                    type: 'circle',
                    source: 'tracks',
                    filter: ['!', ['has', 'point_count']],
                    paint: {
                        'circle-radius': 6,
                        'circle-color': '#10b981',
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': 0.9
                    }
                });

                // D. Clusters
                map.addLayer({
                    id: 'clusters',
                    type: 'circle',
                    source: 'tracks',
                    filter: ['has', 'point_count'],
                    paint: {
                        'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 100, '#f1f075', 750, '#f28cb1'],
                        'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
                    }
                });

                map.addLayer({
                    id: 'cluster-count',
                    type: 'symbol',
                    source: 'tracks',
                    filter: ['has', 'point_count'],
                    layout: {
                        'text-field': '{point_count_abbreviated}',
                        'text-font': ['Open Sans Semibold'],
                        'text-size': 12
                    }
                });



                // --- Events Markers ---
                let eventMarkers = [];
                if (eventsRaw) {
                    eventsRaw.forEach(ev => {
                        const el = document.createElement('div');
                        el.className = 'w-8 h-8 rounded-full border-2 border-white shadow-md bg-orange-500 flex items-center justify-center text-white cursor-pointer hover:scale-110 transition-transform';
                        el.innerHTML = '<i class="ph-bold ph-flag-banner"></i>';

                        const popup = new maplibregl.Popup({ offset: 25 }).setHTML(`
                             <div class="p-3 text-center min-w-[140px]">
                                 <h3 class="font-bold text-slate-800 text-sm mb-1 line-clamp-2">${ev.name}</h3>
                                 <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wide mb-2">${ev.location_city || 'Localisation inconnue'}</p>
                                 <a href="/search?q=${encodeURIComponent(ev.name)}" class="inline-block px-3 py-1.5 bg-orange-50 text-orange-600 text-xs font-bold rounded-lg hover:bg-orange-100 transition-colors">Voir l'événement</a>
                             </div>
                         `);

                        const marker = new maplibregl.Marker({ element: el })
                            .setLngLat([ev.lon, ev.lat])
                            .setPopup(popup)
                            .addTo(map);

                        eventMarkers.push(marker);
                    });
                }

                // Define userMarkers globally accessible for toggle
                window.userMarkers = [];
                // Re-render user markers to store reference
                // (Clearing previous if any - though this runs on load so fine)
                if (usersRaw) {
                    usersRaw.forEach(u => {
                        if (!u.location_lat || !u.location_lon) return;
                        const el = document.createElement('div');
                        el.className = 'w-10 h-10 rounded-full border-2 border-white shadow-md bg-white overflow-hidden cursor-pointer hover:scale-110 transition-transform';
                        if (u.profile_picture) {
                            const img = document.createElement('img');
                            img.src = u.profile_picture;
                            img.className = 'w-full h-full object-cover';
                            el.appendChild(img);
                        } else {
                            el.className += ' flex items-center justify-center bg-indigo-500 text-white font-bold text-xs';
                            el.innerText = u.username.substring(0, 2).toUpperCase();
                        }
                        const popup = new maplibregl.Popup({ offset: 25 }).setHTML(`
                             <div class="p-3 text-center min-w-[120px]">
                                 <div class="w-12 h-12 rounded-full overflow-hidden mx-auto mb-2 border border-slate-100">
                                      ${u.profile_picture ? `<img src="${u.profile_picture}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-indigo-500 flex items-center justify-center text-white text-xs font-bold">${u.username.substring(0, 2).toUpperCase()}</div>`} 
                                 </div>
                                 <h3 class="font-bold text-slate-800 text-sm"><a href="/user/${encodeURIComponent(u.username)}" class="hover:text-brand-600 hover:underline">${u.username}</a></h3>
                                 <p class="text-xs text-slate-500">${u.location_city || 'Membre Kairn'}</p>
                             </div>
                        `);
                        const m = new maplibregl.Marker({ element: el }).setLngLat([u.location_lon, u.location_lat]).setPopup(popup).addTo(map);
                        window.userMarkers.push(m);
                    });
                }
            } catch (e) {
                console.error("Map Load Error:", e);
            }

            // --- Interactions ---

            // 1. Hover on Track Points
            map.on('mouseenter', 'track-points', async (e) => {
                map.getCanvas().style.cursor = 'pointer';

                const feature = e.features[0];
                const trackId = feature.properties.id;

                // Remove existing popup if any
                if (currentPopup) {
                    currentPopup.remove();
                    currentPopup = null;
                }

                // Clear previous trace immediately to avoid confusion
                if (hoveredTrackId !== trackId) {
                    map.getSource('hover-track').setData({ "type": "FeatureCollection", "features": [] });
                }

                const coordinates = feature.geometry.coordinates.slice();
                const description = `
                    <div class="px-4 py-3 min-w-[150px]">
                        <h3 class="font-bold text-slate-900 text-sm mb-1 line-clamp-1">${feature.properties.title}</h3>
                        <div class="flex items-center gap-3 text-xs text-slate-500">
                            <span class="font-mono font-bold text-brand-600">${feature.properties.distance.toFixed(1)}km</span>
                            <span>${Math.round(feature.properties.elevation)}m+</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 italic">Cliquez pour voir les détails</p>
                    </div>
                `;

                // Create new popup
                currentPopup = new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);

                // Fetch Trace
                if (hoveredTrackId !== trackId) {
                    hoveredTrackId = trackId;
                    document.getElementById('loading-indicator').classList.remove('hidden');

                    try {
                        const res = await fetch(`/api/track/${trackId}/geojson`);
                        if (res.ok) {
                            const geojson = await res.json();
                            if (geojson) {
                                map.getSource('hover-track').setData(geojson);
                            }
                        }
                    } catch (err) {
                        console.error("Failed to load trace", err);
                    } finally {
                        document.getElementById('loading-indicator').classList.add('hidden');
                    }
                }
            });

            map.on('mouseleave', 'track-points', () => {
                map.getCanvas().style.cursor = '';
            });

            // Cluster Click -> Zoom
            map.on('click', 'clusters', (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                const clusterId = features[0].properties.cluster_id;
                map.getSource('tracks').getClusterExpansionZoom(clusterId, (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                });
            });

            map.on('mouseenter', 'clusters', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', () => {
                map.getCanvas().style.cursor = '';
            });

            // Click to go to detail
            map.on('click', 'track-points', (e) => {
                const trackId = e.features[0].properties.id;
                window.location.href = `/track/${trackId}`;
            });

            // Expose markers globally for toggles outside this scope
            window.eventMarkers = eventMarkers;

        }); // End map Load

        // MOVE TOGGLES INSIDE or usage of window globals
        // Ideally toggles should be set up once, but they depend on map layers/markers
        // We can set them up here or ensure they access globals.


        // --- Controls Logic (Safe Global Functions) ---
        // Bind to window to ensure global access for onclick
        window.zoomIn = function () { map.zoomIn(); };
        window.zoomOut = function () { map.zoomOut(); };

        window.toggle3D = function () {
            is3D = !is3D;
            const btn = document.getElementById('btn-3d');
            if (is3D) {
                map.easeTo({ pitch: 60, bearing: -17.6, duration: 1000 });
                // Add Terrain if not already
                if (!map.getSource('terrain')) {
                    map.addSource('terrain', {
                        "type": "raster-dem",
                        "tiles": [
                            "https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png"
                        ],
                        "encoding": "terrarium",
                        "tileSize": 256,
                        "maxzoom": 15
                    });
                    map.setTerrain({ 'source': 'terrain', 'exaggeration': 1.2 });
                }
                btn && btn.classList.add('text-brand-600', 'bg-slate-50');
            } else {
                map.easeTo({ pitch: 0, bearing: 0, duration: 1000 });
                btn && btn.classList.remove('text-brand-600', 'bg-slate-50');
            }
        };

        window.toggleSat = function () {
            isSat = !isSat;
            const btn = document.getElementById('btn-sat');
            if (isSat) {
                if (!map.getLayer('satellite-layer')) {
                    map.addLayer({
                        'id': 'satellite-layer',
                        'type': 'raster',
                        'source': {
                            'type': 'raster',
                            'tiles': [
                                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                            ],
                            'tileSize': 256
                        },
                        'paint': {}
                    }, 'heatmap-layer'); // Place below heatmap
                } else {
                    map.setLayoutProperty('satellite-layer', 'visibility', 'visible');
                }
                btn && btn.classList.add('text-brand-600', 'bg-slate-50');
            } else {
                if (map.getLayer('satellite-layer')) {
                    map.setLayoutProperty('satellite-layer', 'visibility', 'none');
                }
                btn && btn.classList.remove('text-brand-600', 'bg-slate-50');
            }
        };

        // Toggles
        const toggleHeat = document.getElementById('toggle-heatmap');
        if (toggleHeat) {
            toggleHeat.addEventListener('change', (e) => {
                if (e.target.checked) map.setLayoutProperty('heatmap-layer', 'visibility', 'visible');
                else map.setLayoutProperty('heatmap-layer', 'visibility', 'none');
            });
        }

        const togglePoints = document.getElementById('toggle-points');
        if (togglePoints) {
            togglePoints.addEventListener('change', (e) => {
                const val = e.target.checked ? 'visible' : 'none';
                if (map.getLayer('track-points')) map.setLayoutProperty('track-points', 'visibility', val);
                if (map.getLayer('clusters')) map.setLayoutProperty('clusters', 'visibility', val);
                if (map.getLayer('cluster-count')) map.setLayoutProperty('cluster-count', 'visibility', val);
            });
        }

        const toggleUsers = document.getElementById('toggle-users');
        if (toggleUsers) {
            toggleUsers.addEventListener('change', (e) => {
                const show = e.target.checked;
                if (window.userMarkers) {
                    window.userMarkers.forEach(m => {
                        const el = m.getElement();
                        el.style.display = show ? 'flex' : 'none'; // Flex because some are flex containers
                        // Or strict removal: show ? m.addTo(map) : m.remove();
                        // Display toggle is cheaper
                        if (!show) el.classList.add('hidden');
                        else el.classList.remove('hidden');
                    });
                }
            });
        }

        const toggleEvents = document.getElementById('toggle-events');
        if (toggleEvents) {
            toggleEvents.addEventListener('change', (e) => {
                const show = e.target.checked;
                if (window.eventMarkers) {
                    window.eventMarkers.forEach(m => {
                        const el = m.getElement();
                        if (!show) el.classList.add('hidden');
                        else el.classList.remove('hidden');
                    });
                }
            });
        }
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col gap-6">

        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-extrabold text-slate-900">Recherche Avancée</h1>
            <a href="/" class="text-sm font-medium text-brand-600 hover:text-brand-700">Retour au tableau de bord</a>
        </div>

        <!-- Comprehensive Filter Form -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
            <form action="/search" method="get" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">

                <!-- 1. Location (City/Country) -->
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Localisation</label>
                    <div class="relative">
                        <input type="text" name="location" value="{{ request.query_params.get('location', '') }}"
                            placeholder="Ville, Pays, Massif..."
                            class="w-full pl-4 pr-4 py-2.5 rounded-xl border-slate-200 bg-slate-50 focus:bg-white focus:border-brand-500 focus:ring-brand-500 shadow-sm transition-all text-sm">
                        <p class="text-xs text-slate-400 mt-1 ml-1">Ex: "Chamonix", "France", "Vercors"</p>
                    </div>
                </div>

                <!-- 2. Distance Range -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Distance (km)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" name="min_dist" placeholder="Min"
                            value="{{ request.query_params.get('min_dist', '') }}"
                            class="w-full px-3 py-2 rounded-xl border-slate-200 text-sm">
                        <span class="text-slate-400">-</span>
                        <input type="number" name="max_dist" placeholder="Max"
                            value="{{ request.query_params.get('max_dist', '') }}"
                            class="w-full px-3 py-2 rounded-xl border-slate-200 text-sm">
                    </div>
                </div>

                <!-- 3. Elevation Range -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Dénivelé (m+)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" name="min_elev" placeholder="Min"
                            value="{{ request.query_params.get('min_elev', '') }}"
                            class="w-full px-3 py-2 rounded-xl border-slate-200 text-sm">
                        <span class="text-slate-400">-</span>
                        <input type="number" name="max_elev" placeholder="Max"
                            value="{{ request.query_params.get('max_elev', '') }}"
                            class="w-full px-3 py-2 rounded-xl border-slate-200 text-sm">
                    </div>
                </div>

                <!-- 4. Activity Type -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Type d'activité</label>
                    <select name="activity_type"
                        class="w-full px-3 py-2.5 rounded-xl border-slate-200 bg-slate-50 text-sm focus:border-brand-500 focus:ring-brand-500">
                        <option value="">Toutes les activités</option>
                        <option value="TRAIL_RUNNING" {% if request.query_params.get('activity_type')=='TRAIL_RUNNING'
                            %}selected{% endif %}>Trail Running</option>
                        <option value="RUNNING" {% if request.query_params.get('activity_type')=='RUNNING' %}selected{%
                            endif %}>Course à pied</option>
                        <option value="HIKING" {% if request.query_params.get('activity_type')=='HIKING' %}selected{%
                            endif %}>Randonnée</option>
                        <option value="MTB_CROSS_COUNTRY" {% if
                            request.query_params.get('activity_type')=='MTB_CROSS_COUNTRY' %}selected{% endif %}>VTT
                            Cross-Country</option>
                        <option value="GRAVEL" {% if request.query_params.get('activity_type')=='GRAVEL' %}selected{%
                            endif %}>Gravel</option>
                        <option value="ROAD_CYCLING" {% if request.query_params.get('activity_type')=='ROAD_CYCLING'
                            %}selected{% endif %}>Vélo de route</option>
                    </select>
                </div>

                <!-- 5. Profile (Ratio D+) -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Profil</label>
                    <select name="ratio_category"
                        class="w-full px-3 py-2.5 rounded-xl border-slate-200 bg-slate-50 text-sm focus:border-brand-500 focus:ring-brand-500">
                        <option value="">Tous les profils</option>
                        <option value="FLAT" {% if request.query_params.get('ratio_category')=='FLAT' %}selected{% endif
                            %}>Plat (< 15m/km)</option>
                        <option value="ROLLING" {% if request.query_params.get('ratio_category')=='ROLLING' %}selected{%
                            endif %}>Roulant (15-40m/km)</option>
                        <option value="HILLY" {% if request.query_params.get('ratio_category')=='HILLY' %}selected{%
                            endif %}>Vallonné (40-80m/km)</option>
                        <option value="MOUNTAIN" {% if request.query_params.get('ratio_category')=='MOUNTAIN'
                            %}selected{% endif %}>Montagneux (> 80m/km)</option>
                    </select>
                </div>

                <!-- 6. Official Race -->
                <div class="flex items-center h-full pt-6">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="is_official" value="true" class="sr-only peer" {% if
                            request.query_params.get('is_official') %}checked{% endif %}>
                        <div
                            class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600">
                        </div>
                        <span class="ms-3 text-sm font-bold text-slate-700">Courses Officielles</span>
                    </label>
                </div>

                <!-- 5. Created By -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Créé par</label>
                    <input type="text" name="author" value="{{ request.query_params.get('author', '') }}"
                        placeholder="Nom d'utilisateur"
                        class="w-full px-3 py-2.5 rounded-xl border-slate-200 bg-slate-50 text-sm">
                </div>

                <!-- 6. Submit -->
                <div class="md:col-span-3 lg:col-span-4 flex justify-end">
                    <button type="submit"
                        class="bg-brand-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-brand-700 transition-colors shadow-md">
                        Rechercher
                    </button>
                </div>

            </form>
        </div>

        <!-- Results -->
        <div id="results-container">
            {% include 'search_results_list.html' %}
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const resultsContainer = document.getElementById('results-container');
        const inputs = form.querySelectorAll('input, select');

        let debounceTimer;

        function fetchResults() {
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            params.append('ajax', '1');

            // Show loading state (opacity)
            resultsContainer.style.opacity = '0.5';

            fetch(`${form.action}?${params.toString()}`)
                .then(response => response.text())
                .then(html => {
                    resultsContainer.innerHTML = html;
                    resultsContainer.style.opacity = '1';

                    // Update URL without refreshing
                    const newUrl = `${window.location.pathname}?${params.toString().replace('&ajax=1', '')}`;
                    window.history.pushState({}, '', newUrl);
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultsContainer.style.opacity = '1';
                });
        }

        inputs.forEach(input => {
            if (input.type === 'text' || input.type === 'number') {
                input.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(fetchResults, 500); // 500ms debounce for typing
                });
            } else {
                input.addEventListener('change', fetchResults);
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            fetchResults();
        });
    });
</script>
{% endblock %}
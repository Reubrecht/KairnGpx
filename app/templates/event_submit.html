{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-slate-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">
                    {% if event %}
                    Édition : <span class="text-brand-600">{{ event.name }}</span>
                    {% else %}
                    Création d'Événement
                    {% endif %}
                </h1>
                <p class="text-slate-500 mt-2">
                    {% if event %}Modifiez les détails de l'événement et gérez ses éditions.{% else %}Remplissez les
                    informations principales pour créer la structure de l'événement.{% endif %}
                </p>
            </div>
            <a href="/superadmin#events"
                class="bg-white border border-slate-200 text-slate-600 hover:text-slate-900 px-4 py-2 rounded-xl font-bold text-sm transition-all shadow-sm flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i> Annuler
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Main Form -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h2 class="font-bold text-slate-800 flex items-center gap-2">
                            <i class="ph-fill ph-info text-brand-500"></i> Informations Générales
                        </h2>
                        <button type="button" id="btn-ai-normalize"
                            class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 transition-colors border border-indigo-200">
                            <i class="ph-fill ph-sparkle"></i> Normaliser via Gemini
                        </button>
                    </div>

                    <form
                        action="{% if event %}/superadmin/events/{{ event.id }}/update{% else %}/superadmin/events{% endif %}"
                        method="POST" class="p-6 space-y-6">
                        {% if request_id %}
                        <input type="hidden" name="request_id" value="{{ request_id }}">
                        {% endif %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700">Nom de l'événement</label>
                                <input type="text" name="name" id="eventName" required
                                    value="{{ event.name if event else (request_name if request_name else '') }}"
                                    class="w-full rounded-xl border-slate-200 focus:border-brand-500 focus:ring-brand-500 font-bold text-slate-900"
                                    placeholder="Ex: UTMB Mont-Blanc">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700">Slug (URL)</label>
                                <input type="text" name="slug" id="eventSlug" required
                                    value="{{ event.slug if event else (request_slug if request_slug else '') }}"
                                    class="w-full rounded-xl border-slate-200 bg-slate-50 text-slate-600 font-mono text-sm"
                                    placeholder="utmb-mont-blanc">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Circuit / Série</label>
                            <input type="text" name="circuit" value="{{ event.circuit if event else '' }}"
                                class="w-full rounded-xl border-slate-200 focus:border-brand-500"
                                placeholder="Ex: UTMB World Series, Golden Trail Series...">
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700">Description Complète</label>
                            <textarea name="description" rows="6"
                                class="w-full rounded-xl border-slate-200 focus:border-brand-500 text-sm leading-relaxed"
                                placeholder="Description détaillée de l'événement, son histoire, son ambiance...">{{ event.description if event else '' }}</textarea>
                            <p class="text-xs text-slate-400 text-right">Markdown supporté</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2 relative">
                                <label class="block text-sm font-bold text-slate-700">Lieu / Région</label>
                                <div class="relative">
                                    <input type="text" id="location-input" name="location_display"
                                        value="{% if event %}{% if event.city %}{{ event.city }}{% if event.country %}, {{ event.country }}{% endif %}{% else %}{{ event.region or '' }}{% endif %}{% endif %}"
                                        class="w-full rounded-xl border-slate-200 focus:border-brand-500"
                                        placeholder="Rechercher une ville, une région..." autocomplete="off">

                                    <!-- Hidden Fields for Storage -->
                                    <input type="hidden" name="region" id="input-region"
                                        value="{{ event.region if event else '' }}">
                                    <input type="hidden" name="city" id="input-city"
                                        value="{{ event.city if event else '' }}">
                                    <input type="hidden" name="country" id="input-country"
                                        value="{{ event.country if event else '' }}">

                                    <!-- Suggestions -->
                                    <ul id="location-suggestions"
                                        class="hidden absolute z-50 w-full bg-white border border-slate-200 rounded-xl shadow-xl mt-1 max-h-60 overflow-y-auto">
                                    </ul>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700">Site Web Officiel</label>
                                <input type="url" name="website"
                                    value="{{ event.website if event else (request_website if request_website else '') }}"
                                    class="w-full rounded-xl border-slate-200 focus:border-brand-500 text-blue-600"
                                    placeholder="https://...">
                            </div>
                        </div>

                        <div class="pt-6 border-t border-slate-100 flex justify-end gap-3">
                            <a href="/superadmin#events"
                                class="px-6 py-2.5 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition-colors">Annuler</a>
                            <button type="submit"
                                class="bg-brand-600 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all flex items-center gap-2">
                                <i class="ph-bold ph-floppy-disk"></i> Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar (Context & Tips) -->
            <div class="space-y-6">
                <!-- Preview Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-900 mb-4">Aperçu Standard</h3>
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                        <div class="flex items-center gap-3 mb-3">
                            <div
                                class="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600">
                                <i class="ph-fill ph-trophy text-xl"></i>
                            </div>
                            <div>
                                <div class="h-4 w-32 bg-slate-200 rounded mb-1"></div>
                                <div class="h-3 w-20 bg-slate-100 rounded"></div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="h-2 w-full bg-slate-100 rounded"></div>
                            <div class="h-2 w-full bg-slate-100 rounded"></div>
                            <div class="h-2 w-2/3 bg-slate-100 rounded"></div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-4 leading-relaxed">
                        Les événements sont la structure parente. Ils contiennent plusieurs <strong>éditions</strong>
                        (par année), qui elles-mêmes contiennent plusieurs <strong>parcours</strong>.
                    </p>
                </div>

                {% if event %}
                <!-- Editions Manager Quick Link -->
                <div class="bg-slate-900 text-white rounded-2xl shadow-lg p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-8 transform translate-x-1/3 -translate-y-1/3 opacity-10">
                        <i class="ph-fill ph-calendar-plus text-9xl"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2 relative z-10">Gérer les Éditions</h3>
                    <p class="text-slate-400 text-sm mb-6 relative z-10">Ajoutez des années (2025, 2026...) et
                        configurez les courses pour chaque édition.</p>
                    <!-- Current flow returns to dashboard to manage editions, communicating this -->
                    <div class="text-xs text-brand-300 relative z-10">
                        <i class="ph-fill ph-info mr-1"></i> Sauvegardez d'abord pour revenir au tableau de bord et
                        ajouter des éditions.
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
    // Auto-slugify
    const nameInput = document.getElementById('eventName');
    const slugInput = document.getElementById('eventSlug');

    const slugify = (text) => {
        return text
            .toString()
            .normalize('NFD')                   // Split accented characters
            .replace(/[\u0300-\u036f]/g, '')   // Remove accents
            .toLowerCase()
            .trim()
            .replace(/\s+/g, '-')              // Replace spaces with -
            .replace(/[^\w\-]+/g, '')          // Remove all non-word chars
            .replace(/\-\-+/g, '-');           // Replace multiple - with single -
    };

    if (nameInput && slugInput) {
        nameInput.addEventListener('input', (e) => {
            if (!slugInput.value || slugInput.value === slugify(e.target.value.slice(0, -1))) {
                // Only auto-update if strictly following or empty, simple heuristic
                slugInput.value = slugify(e.target.value);
            }
        });

        // Force update on blur if empty
        nameInput.addEventListener('blur', () => {
            if (!slugInput.value) slugInput.value = slugify(nameInput.value);
        });
    }

    // AI Normalization
    const btnAi = document.getElementById('btn-ai-normalize');
    if (btnAi) {
        btnAi.addEventListener('click', async () => {
            const originalText = btnAi.innerHTML;
            btnAi.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Reflexion...';
            btnAi.disabled = true;

            try {
                const formData = new FormData();
                formData.append('name', document.getElementById('eventName').value);
                // Use the region hidden input or fallback to visual input
                formData.append('region', document.getElementById('input-region').value || document.getElementById('location-input').value);
                formData.append('website', document.querySelector('input[name="website"]').value);
                formData.append('description', document.querySelector('textarea[name="description"]').value);

                const response = await fetch('/api/admin/normalize_event', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.normalized_name) document.getElementById('eventName').value = data.normalized_name;
                    if (data.slug) document.getElementById('eventSlug').value = data.slug;
                    if (data.region) {
                        document.getElementById('input-region').value = data.region;
                        // If we have a location input, try to set it nicely
                        document.getElementById('location-input').value = data.region;
                    }
                    if (data.circuit) document.querySelector('input[name="circuit"]').value = data.circuit;
                    if (data.description) document.querySelector('textarea[name="description"]').value = data.description;

                    // Highlight success
                    btnAi.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                    btnAi.classList.remove('bg-indigo-50', 'text-indigo-600');
                    setTimeout(() => {
                        btnAi.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
                        btnAi.classList.add('bg-indigo-50', 'text-indigo-600');
                    }, 2000);
                } else {
                    alert('Erreur lors de la normalisation AI.');
                }
            } catch (e) {
                console.error(e);
                alert('Erreur de connexion.');
            } finally {
                btnAi.innerHTML = originalText;
                btnAi.disabled = false;
            }
        });
    }

    // --- LOCATION AUTOCOMPLETE ---
    const locInput = document.getElementById('location-input');
    const locList = document.getElementById('location-suggestions');
    const inputRegion = document.getElementById('input-region');
    const inputCity = document.getElementById('input-city');
    const inputCountry = document.getElementById('input-country');
    let locTimer;

    if (locInput && locList) {
        locInput.addEventListener('input', function () {
            const query = this.value;

            // Sync fallback to region
            if (inputRegion) inputRegion.value = query;

            if (query.length < 3) {
                locList.classList.add('hidden');
                return;
            }

            clearTimeout(locTimer);
            locTimer = setTimeout(() => {
                fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lang=fr&limit=5`)
                    .then(res => res.json())
                    .then(data => {
                        locList.innerHTML = '';
                        if (data.features && data.features.length > 0) {
                            locList.classList.remove('hidden');
                            data.features.forEach(feature => {
                                const props = feature.properties;
                                const li = document.createElement('li');
                                li.className = "px-4 py-2 hover:bg-slate-50 cursor-pointer text-sm text-slate-700 flex flex-col border-b border-slate-50 last:border-0";

                                let label = props.name;
                                let context = [];
                                if (props.city && props.name !== props.city) context.push(props.city);
                                if (props.state) context.push(props.state);
                                if (props.country) context.push(props.country);

                                li.innerHTML = `
                                    <span class="font-bold">${label}</span>
                                    <span class="text-xs text-slate-400">${context.join(', ')}</span>
                                `;

                                li.addEventListener('click', () => {
                                    // Populate Fields
                                    const city = props.city || (props.osm_key === 'place' ? props.name : '');
                                    const region = props.state || props.name; // Fallback
                                    const country = props.country || '';

                                    // Display Logic
                                    let displayVal = props.name;
                                    if (country) displayVal += `, ${country}`;
                                    locInput.value = displayVal;

                                    // Hidden Fields
                                    if (inputCity) inputCity.value = city;
                                    if (inputRegion) inputRegion.value = region;
                                    if (inputCountry) inputCountry.value = country;

                                    locList.classList.add('hidden');
                                });
                                locList.appendChild(li);
                            });
                        } else {
                            locList.classList.add('hidden');
                        }
                    });
            }, 300);
        });

        // Hide on click outside
        document.addEventListener('click', function (e) {
            if (!locInput.contains(e.target) && !locList.contains(e.target)) {
                locList.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %}
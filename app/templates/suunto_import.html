{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-64px)] overflow-hidden">

    <!-- Top Bar: Instructions & Drop Zone -->
    <div
        class="bg-slate-900 text-white p-4 shadow-md z-10 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex items-center">
            <div>
                <h5 class="text-lg font-bold flex items-center gap-2">
                    <i class="ph-bold ph-path"></i> Suunto Integrator
                </h5>
                <p class="text-slate-400 text-xs md:text-sm">1. Créez votre trace. 2. Exportez en GPX. 3. Glissez le
                    fichier ici.</p>
            </div>
        </div>

        <!-- The Drop Zone -->
        <div id="drop-zone"
            class="border-2 border-dashed border-slate-600 rounded-lg px-6 py-2 flex items-center justify-center text-center cursor-pointer hover:bg-slate-800 hover:border-brand-500 transition-all min-w-[300px]">
            <i class="ph-bold ph-upload-simple text-2xl mr-3 text-brand-500"></i>
            <div>
                <span class="block font-bold text-sm">Glissez votre GPX ici</span>
                <span class="block text-xs text-slate-500">ou cliquez pour sélectionner</span>
            </div>
            <input type="file" id="file-input" class="hidden" accept=".gpx">
        </div>
    </div>

    <!-- The Iframe -->
    <div class="flex-grow relative bg-slate-100">
        <div class="absolute inset-0 flex items-center justify-center -z-0">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-600"></div>
        </div>
        <iframe src="https://routeplanner.suunto.com/" class="w-full h-full relative z-1" frameborder="0"
            allow="geolocation">
        </iframe>
    </div>

</div>

<!-- Loading Overlay for Upload -->
<div id="upload-overlay"
    class="fixed inset-0 bg-slate-900/90 z text-white z-[9999] hidden flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-4 border-brand-500 border-t-transparent mb-4"></div>
    <h4 class="text-xl font-bold">Importation de la trace...</h4>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadOverlay = document.getElementById('upload-overlay');

    // Drag & Drop visual feedback
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-brand-500', 'bg-slate-800');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-brand-500', 'bg-slate-800');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-brand-500', 'bg-slate-800');

        if (e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    // Click to select
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        if (fileInput.files.length) {
            handleFile(fileInput.files[0]);
        }
    });

    function handleFile(file) {
        if (!file.name.toLowerCase().endsWith('.gpx')) {
            alert('Veuillez sélectionner un fichier GPX.');
            return;
        }

        uploadOverlay.classList.remove('hidden');
        uploadOverlay.classList.add('flex');

        const formData = new FormData();
        formData.append('file', file);

        // Staging upload
        fetch('/upload/stage', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error('Upload failed');
                return response.json();
            })
            .then(data => {
                if (data.temp_id) {
                    window.location.href = '/upload?temp_id=' + data.temp_id;
                } else {
                    throw new Error('No temp_id returned');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Erreur lors de l\'upload');
                uploadOverlay.classList.add('hidden');
                uploadOverlay.classList.remove('flex');
            });
    }
</script>

<style>
    /* Fullscreen corrections */
    main {
        padding-bottom: 0 !important;
        height: calc(100vh - 64px);
        /* Subtract header height */
    }

    footer {
        display: none !important;
    }
</style>
{% endblock %}
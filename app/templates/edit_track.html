{% extends "base.html" %}

{% block content %}
<div class="min-h-[calc(100vh-64px)] bg-slate-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">

        <div class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Modifier la Trace</h1>
            <p class="mt-2 text-lg text-slate-600">{{ track.title }}</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
            <form action="/track/{{ track.id }}/edit" method="post" class="divide-y divide-slate-100">

                <!-- 1. Core Info -->
                <div class="p-8 space-y-6">
                    <!-- ... Header ... -->
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 text-sm font-bold">1</span>
                        Informations G√©n√©rales
                    </h2>

                    <!-- Title/Desc/Vis -->
                    <div class="grid grid-cols-1 gap-6">
                        <!-- ... Existing Inputs ... -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Titre de la sortie</label>
                            <input type="text" name="title" value="{{ track.title }}" required
                                class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 transition-colors">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <textarea name="description" rows="4"
                                class="w-full rounded-lg border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 transition-colors">{{ track.description or '' }}</textarea>
                        </div>

                        <!-- NEW SPLIT FOR VISIBILITY & TYPE -->
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Visibility -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Visibilit√©</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="visibility" value="public" class="peer sr-only" {% if
                                            track.visibility.value=='public' %}checked{% endif %}>
                                        <div
                                            class="h-10 w-full bg-white border border-slate-200 rounded-lg flex items-center justify-center text-center hover:shadow-md peer-checked:bg-emerald-50 peer-checked:border-emerald-500 peer-checked:text-emerald-700 transition-all">
                                            <span class="text-sm font-semibold">Publique</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="visibility" value="unlisted" class="peer sr-only" {%
                                            if track.visibility.value=='unlisted' %}checked{% endif %}>
                                        <div
                                            class="h-10 w-full bg-white border border-slate-200 rounded-lg flex items-center justify-center text-center hover:shadow-md peer-checked:bg-amber-50 peer-checked:border-amber-500 peer-checked:text-amber-700 transition-all">
                                            <span class="text-sm font-semibold">Non r√©pertori√©e</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="visibility" value="private" class="peer sr-only" {% if
                                            track.visibility.value=='private' %}checked{% endif %}>
                                        <div
                                            class="h-10 w-full bg-white border border-slate-200 rounded-lg flex items-center justify-center text-center hover:shadow-md peer-checked:bg-slate-100 peer-checked:border-slate-500 peer-checked:text-slate-700 transition-all">
                                            <span class="text-sm font-semibold">Priv√©e</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Activity Type Checkbox -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-3">Type d'activit√©</label>
                                <div class="flex flex-wrap gap-2">
                                    {% for activity in activity_options %}
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="activity_type" value="{{ activity }}"
                                            class="peer sr-only" {% if track.activity_type.value==activity %}checked{%
                                            endif %}>
                                        <div
                                            class="px-4 py-2 bg-white border border-slate-200 rounded-full flex items-center justify-center text-center hover:shadow-md peer-checked:bg-brand-50 peer-checked:border-brand-500 peer-checked:text-brand-700 transition-all">
                                            <span class="text-sm font-semibold">{{ activity }}</span>
                                        </div>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1.5 COMPETITION CONTEXT -->
                <div class="p-8 space-y-6 bg-amber-50/30 border-y border-amber-100/50">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-amber-100 text-amber-700 text-sm font-bold">‚òÖ</span>
                        Contexte Comp√©tition
                    </h2>
                    <p class="text-sm text-slate-500 mb-4">Liez cette trace √† une course officielle existante.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Event Select -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">√âv√©nement</label>
                            <select id="race-select"
                                class="w-full rounded-lg border-slate-300 text-sm focus:border-amber-500 focus:ring-amber-500">
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>
                        <!-- Edition Select -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">√âdition / Ann√©e</label>
                            <select id="edition-select"
                                class="w-full rounded-lg border-slate-300 text-sm focus:border-amber-500 focus:ring-amber-500"
                                disabled>
                                <option value="">-- Ann√©e --</option>
                            </select>
                        </div>
                        <!-- Route Select -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Parcours</label>
                            <select id="route-select" name="race_route_id"
                                class="w-full rounded-lg border-slate-300 text-sm focus:border-amber-500 focus:ring-amber-500"
                                disabled>
                                <option value="">-- Parcours --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Missing Event Button -->
                    <div class="flex justify-end mt-2">
                        <button type="button" onclick="openRequestModal()"
                            class="text-xs font-bold text-amber-600 hover:text-amber-800 underline">
                            L'√©v√©nement n'existe pas ?
                        </button>
                    </div>
                </div>

                <!-- 2. Environment -->
                <div class="p-8 space-y-6 bg-slate-50/30">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 text-sm font-bold">2</span>
                        Environnement (Choix Multiples)
                    </h2>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {% for env_val, env_label, color_classes in [
                        ('high_mountain', 'Haute Montagne', 'peer-checked:bg-purple-50 peer-checked:border-purple-500
                        peer-checked:text-purple-700'),
                        ('mid_mountain', 'Moyenne Montagne', 'peer-checked:bg-indigo-50 peer-checked:border-indigo-500
                        peer-checked:text-indigo-700'),
                        ('forest', 'For√™t', 'peer-checked:bg-green-50 peer-checked:border-green-500
                        peer-checked:text-green-700'),
                        ('pasture', 'P√¢turage', 'peer-checked:bg-lime-50 peer-checked:border-lime-500
                        peer-checked:text-lime-700'),
                        ('coastal', 'C√¥tier', 'peer-checked:bg-cyan-50 peer-checked:border-cyan-500
                        peer-checked:text-cyan-700'),
                        ('lake_river', 'Lac / Rivi√®re', 'peer-checked:bg-sky-50 peer-checked:border-sky-500
                        peer-checked:text-sky-700'),
                        ('rural', 'Campagne', 'peer-checked:bg-orange-50 peer-checked:border-orange-500
                        peer-checked:text-orange-700'),
                        ('desert', 'Aride', 'peer-checked:bg-amber-50 peer-checked:border-amber-500
                        peer-checked:text-amber-700'),
                        ('mineral', 'Rocheux', 'peer-checked:bg-slate-50 peer-checked:border-slate-500
                        peer-checked:text-slate-700'),
                        ('ice', 'Neige / Glace', 'peer-checked:bg-blue-50 peer-checked:border-blue-500
                        peer-checked:text-blue-700'),
                        ('urban', 'Urbain', 'peer-checked:bg-gray-50 peer-checked:border-gray-500
                        peer-checked:text-gray-700'),
                        ('volcanic', 'Volcanique', 'peer-checked:bg-rose-50 peer-checked:border-rose-500
                        peer-checked:text-rose-700')
                        ] %}
                        <label class="cursor-pointer group">
                            <input type="checkbox" name="environment" value="{{ env_val }}" class="peer sr-only" {% if
                                track.environment and env_val in track.environment %}checked{% endif %}>
                            <div
                                class="h-14 w-full bg-white border border-slate-200 rounded-xl flex items-center justify-center text-center hover:shadow-md transition-all {{ color_classes }}">
                                <span class="text-sm font-semibold">{{ env_label }}</span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- 3. Logistics & Extras -->
                <div class="p-8 space-y-8">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-100 text-brand-700 text-sm font-bold">3</span>
                        Logistique & Autres
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <!-- Scenery / Note Paysage -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-4">Note Paysage</label>
                            <div class="flex items-center gap-2">
                                <div class="flex flex-row-reverse justify-end gap-1 group">
                                    {% for i in range(5, 0, -1) %}
                                    <input type="radio" name="scenery_rating" id="star{{i}}" value="{{i}}"
                                        class="peer sr-only" {% if track.scenery_rating==i %}checked{% endif %}>
                                    <label for="star{{i}}"
                                        class="cursor-pointer text-slate-300 peer-checked:text-amber-400 hover:text-amber-400 peer-hover:text-amber-400 transition-colors">
                                        <svg class="w-10 h-10 transform hover:scale-110 transition-transform"
                                            fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                        </svg>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Technicity -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-4">Technicit√© (0-10)</label>
                            <div class="flex items-center w-full max-w-[200px]">
                                <button type="button" onclick="adjustTech(-0.5)"
                                    class="w-12 h-12 rounded-l-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-xl border-r border-slate-200 transition-colors">-</button>
                                <input type="number" name="technicity_score" id="tech-input" step="0.1" max="10" min="0"
                                    value="{{ track.technicity_score or 0 }}"
                                    class="w-full h-12 text-center border-0 bg-slate-50 font-bold text-lg text-slate-700 focus:ring-0">
                                <button type="button" onclick="adjustTech(0.5)"
                                    class="w-12 h-12 rounded-r-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-xl border-l border-slate-200 transition-colors">+</button>
                            </div>
                        </div>

                        <!-- Points of Interest & Ravitos -->
                        <div class="md:col-span-2 mt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-4">Points d'Int√©r√™t &
                                Ravitaillements</label>

                            <!-- Logic: Hidden Input to store JSON -->
                            <input type="hidden" name="ravitos" id="ravitos-json">
                            <!-- Helper for water count (optional if we calculate it from JSON backend side, but good for UI sync) -->
                            <input type="hidden" name="water_points_count" id="water-points-count-input"
                                value="{{ track.water_points_count }}">

                            <div id="ravitos-container" class="space-y-3 mb-4">
                                <!-- Dynamic Rows will go here -->
                                <!-- Initial State Empty Message -->
                                <div id="no-ravitos-msg"
                                    class="text-sm text-slate-400 italic text-center py-4 border border-dashed border-slate-200 rounded-lg">
                                    Aucun point d'int√©r√™t ajout√©.
                                </div>
                            </div>

                            <button type="button" onclick="addRavitoRow()"
                                class="w-full py-2 border-2 border-dashed border-slate-200 rounded-lg text-slate-500 font-bold hover:border-brand-500 hover:text-brand-600 transition-colors flex items-center justify-center gap-2">
                                <i class="ph-bold ph-plus"></i> Ajouter un point
                            </button>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tags</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-slate-400">#</span>
                            </div>
                            <input type="text" name="tags" placeholder="Sommet, Lac, Technique, ..."
                                value="{{ track.tags | join(', ') if track.tags else '' }}"
                                class="w-full pl-8 pr-4 py-3 rounded-xl border-slate-200 bg-slate-50 focus:bg-white focus:border-brand-500 focus:ring-brand-500 shadow-sm transition-all text-sm">
                        </div>
                        <p class="mt-2 text-xs text-slate-500">Ajoutez des mots-cl√©s s√©par√©s par des virgules pour
                            faciliter la recherche.</p>
                    </div>
                </div>

                <!-- ZONE SUPER ADMIN -->
                {% if user.is_admin %}
                <div class="p-8 space-y-6 bg-slate-900 text-white border-t border-slate-800">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-brand-400">
                            <i class="ph-fill ph-shield-check text-2xl"></i>
                            Zone Super Admin
                        </h2>
                        <button type="submit" formaction="/track/{{ track.id }}/analyze" formmethod="post"
                            class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-indigo-500/20">
                            <i class="ph-bold ph-magic-wand"></i> Relancer IA
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Owner Transfer -->
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-1">Propri√©taire (Username)</label>
                            <input type="text" name="owner_name" value="{{ track.user_obj.username }}"
                                class="w-full rounded-lg border-slate-700 bg-slate-800 text-white focus:border-brand-500 focus:ring-brand-500">
                            <p class="text-xs text-slate-500 mt-1">Attention: Transf√®re la propri√©t√©.</p>
                        </div>

                        <!-- Verification Status -->
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-1">Statut V√©rification</label>
                            <select name="verification_status"
                                class="w-full rounded-lg border-slate-700 bg-slate-800 text-white focus:border-brand-500">
                                {% for status in ['pending', 'verified_by_algo', 'verified_by_human', 'rejected'] %}
                                <option value="{{ status }}" {% if track.verification_status.value==status %}selected{%
                                    endif %}>
                                    {{ status|upper }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Official Route Toggle -->
                        <div class="flex items-center gap-3 p-4 bg-slate-800 rounded-xl border border-slate-700">
                            <input type="checkbox" name="is_official" id="is_official" value="true"
                                class="w-5 h-5 rounded text-brand-600 focus:ring-brand-600 bg-slate-700 border-slate-600"
                                {% if track.is_official_route %}checked{% endif %}>
                            <label for="is_official" class="cursor-pointer">
                                <span class="block font-bold text-white">Route Officielle</span>
                                <span class="block text-xs text-slate-400">Si coch√©, cette trace est consid√©r√©e comme
                                    une
                                    r√©f√©rence.</span>
                            </label>
                        </div>
                    </div>

                    <!-- Destructive Actions -->
                    <div class="pt-4 border-t border-slate-800 flex justify-end">
                        <button type="submit" name="action" value="delete_force"
                            onclick="return confirm('SUPPRESSION D√âFINITIVE IMMEDIATE ?')"
                            class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50 rounded-lg text-sm font-bold transition-colors">
                            <i class="ph-bold ph-trash mr-1"></i> Force Delete
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Footer Action -->
                <div class="p-8 bg-slate-50 border-t border-slate-100 flex items-center justify-end gap-4">
                    <a href="/track/{{ track.id }}" class="text-slate-600 font-medium hover:text-slate-800">Annuler</a>
                    <button type="submit"
                        class="px-8 py-3 bg-brand-600 text-white font-bold rounded-full shadow-lg shadow-brand-500/30 hover:bg-brand-700 hover:shadow-brand-500/40 transform hover:-translate-y-0.5 transition-all">
                        Enregistrer les modifications
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Event Request Modal -->
<div id="request-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <form action="/request_event" method="post" class="p-6">
                    <h3 class="text-xl font-bold text-slate-900 mb-4">Demander un √âv√©nement</h3>
                    <p class="text-sm text-slate-500 mb-6">L'√©v√©nement que vous cherchez n'est pas dans la liste ?
                        Remplissez ce formulaire pour qu'un administrateur l'ajoute.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Nom de l'√©v√©nement</label>
                            <input type="text" name="event_name" required
                                class="w-full rounded-lg border-slate-300 focus:ring-brand-500 focus:border-brand-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Ann√©e (Optionnel)</label>
                                <input type="number" name="year" placeholder="2024"
                                    class="w-full rounded-lg border-slate-300 focus:ring-brand-500 focus:border-brand-500">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Site Web (Optionnel)</label>
                                <input type="url" name="website" placeholder="https://..."
                                    class="w-full rounded-lg border-slate-300 focus:ring-brand-500 focus:border-brand-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">Commentaire</label>
                            <textarea name="comment" rows="2"
                                class="w-full rounded-lg border-slate-300 focus:ring-brand-500 focus:border-brand-500"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" onclick="closeRequestModal()"
                            class="px-4 py-2 text-slate-600 font-bold hover:bg-slate-50 rounded-lg">Annuler</button>
                        <button type="submit"
                            class="px-4 py-2 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700">Envoyer la
                            demande</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Race Data Serialization ---
    const racesData = {{ races_json | safe }};
    /*
        {% for r in races %}
    {
        id: { { r.id } },
        name: "{{ r.name|replace('"', '\\"') }}",
            editions: [
                {% for e in r.editions %}
    {
        id: { { e.id } },
        year: { { e.year } },
        routes: [
            {% for route in e.routes %}
    { id: { { route.id } }, name: "{{ route.name|replace('"', '\\"') }}" },
    {% endfor %}
                    ]
                },
    {% endfor %}
            ]
        },
    {% endfor %}
    ]; */

    // --- Dropdown Logic ---
    const raceSelect = document.getElementById('race-select');
    const editionSelect = document.getElementById('edition-select');
    const routeSelect = document.getElementById('route-select');

    // Init Race Select
    racesData.sort((a, b) => a.name.localeCompare(b.name)).forEach(r => {
        const op = document.createElement('option');
        op.value = r.id;
        op.textContent = r.name;
        raceSelect.appendChild(op);
    });

    raceSelect.addEventListener('change', () => {
        const rId = parseInt(raceSelect.value);
        editionSelect.innerHTML = '<option value="">-- Ann√©e --</option>';
        routeSelect.innerHTML = '<option value="">-- Parcours --</option>';
        routeSelect.disabled = true;

        if (!rId) {
            editionSelect.disabled = true;
            return;
        }

        const race = racesData.find(r => r.id === rId);
        if (race && race.editions) {
            race.editions.sort((a, b) => b.year - a.year).forEach(e => {
                const op = document.createElement('option');
                op.value = e.id;
                op.textContent = e.year;
                editionSelect.appendChild(op);
            });
            editionSelect.disabled = false;
        }
    });

    editionSelect.addEventListener('change', () => {
        const rId = parseInt(raceSelect.value);
        const eId = parseInt(editionSelect.value);
        routeSelect.innerHTML = '<option value="">-- Parcours --</option>';

        if (!eId) {
            routeSelect.disabled = true;
            return;
        }

        const race = racesData.find(r => r.id === rId);
        const edition = race.editions.find(e => e.id === eId);

        if (edition && edition.routes) {
            edition.routes.forEach(ro => {
                const op = document.createElement('option');
                op.value = ro.id;
                op.textContent = ro.name;
                routeSelect.appendChild(op);
            });
            routeSelect.disabled = false;
        }
    });

    // --- Modal Logic ---
    const modal = document.getElementById('request-modal');
    function openRequestModal() {
        modal.classList.remove('hidden');
    }
    function closeRequestModal() {
        modal.classList.add('hidden');
    }

    // --- Existing Utilities ---
    // Ravitos Management
    const ravitosContainer = document.getElementById('ravitos-container');
    const ravitosJsonInput = document.getElementById('ravitos-json');
    const waterPointsCountInput = document.getElementById('water-points-count-input'); // Optional
    const noRavitosMsg = document.getElementById('no-ravitos-msg');

    // Parse existing POIs from Template
    const existingPois = {{ track.points_of_interest | tojson | safe }} || [];

    // Initialize
    if (existingPois && existingPois.length > 0) {
        if (noRavitosMsg) noRavitosMsg.classList.add('hidden');
        existingPois.forEach(poi => addRavitoRow(poi));
        updateRavitosJson();
    }

    function addRavitoRow(data = null) {
        if (noRavitosMsg) noRavitosMsg.classList.add('hidden');

        const rowId = 'ravito-' + Date.now() + Math.random().toString(36).substr(2, 5);;
        const div = document.createElement('div');
        div.className = "flex items-center gap-2 animate-fade-in-up md:flex-row flex-col bg-slate-50 p-2 rounded-lg border border-slate-200";
        div.id = rowId;

        const nameVal = data ? data.name : "";
        const kmVal = data ? data.km : "";
        const typeVal = data ? data.type : "water"; // default

        div.innerHTML = `
        <div class="flex-grow w-full md:w-auto">
            <input type="text" placeholder="Nom (ex: Refuge A)" value="${nameVal}" 
                class="w-full rounded-md border-slate-200 text-sm focus:border-brand-500 focus:ring-brand-500 ravito-name" 
                oninput="updateRavitosJson()">
        </div>
        <div class="w-full md:w-24">
            <div class="relative">
                <input type="number" placeholder="KM" step="0.1" value="${kmVal}" 
                    class="w-full rounded-md border-slate-200 text-sm focus:border-brand-500 focus:ring-brand-500 ravito-km pl-8" 
                    oninput="updateRavitosJson()">
                    <span class="absolute left-2 top-2 text-slate-400 text-xs font-bold">KM</span>
            </div>
        </div>
        <div class="w-full md:w-32">
            <select class="w-full rounded-md border-slate-200 text-sm focus:border-brand-500 focus:ring-brand-500 ravito-type" onchange="updateRavitosJson()">
                <option value="water" ${typeVal === 'water' ? 'selected' : ''}>üíß Eau</option>
                <option value="food" ${typeVal === 'food' ? 'selected' : ''}>üçé Ravitaillement</option>
                <option value="base_life" ${typeVal === 'base_life' ? 'selected' : ''}>‚õ∫ Base Vie</option>
                <option value="checkpoint" ${typeVal === 'checkpoint' ? 'selected' : ''}>üö© Point de passage</option>
                <option value="summit" ${typeVal === 'summit' ? 'selected' : ''}>üèîÔ∏è Sommet</option>
            </select>
        </div>
        <button type="button" onclick="removeRavitoRow('${rowId}')" class="text-red-400 hover:text-red-600 p-2">
            <i class="ph-bold ph-trash"></i>
        </button>
    `;

        ravitosContainer.appendChild(div);
        updateRavitosJson();
    }

    function removeRavitoRow(id) {
        const row = document.getElementById(id);
        if (row) {
            row.remove();
            updateRavitosJson();

            // Check if empty
            const rows = ravitosContainer.querySelectorAll('div[id^="ravito-"]');
            if (rows.length === 0) {
                if (noRavitosMsg) noRavitosMsg.classList.remove('hidden');
            }
        }
    }

    function updateRavitosJson() {
        const rows = ravitosContainer.querySelectorAll('div[id^="ravito-"]');
        const data = [];
        let waterCount = 0;

        rows.forEach(row => {
            const name = row.querySelector('.ravito-name').value;
            const km = row.querySelector('.ravito-km').value;
            const type = row.querySelector('.ravito-type').value;

            // Only add if name or km is present
            if (name || km) {
                data.push({
                    name: name,
                    km: km,
                    type: type
                });

                if (type === 'water' || type === 'food' || type === 'base_life') {
                    waterCount++;
                }
            }
        });

        // Sort by KM
        data.sort((a, b) => parseFloat(a.km || 0) - parseFloat(b.km || 0));

        ravitosJsonInput.value = JSON.stringify(data);
        if (waterPointsCountInput) {
            waterPointsCountInput.value = waterCount;
        }
    }

    function adjustTech(amount) {
        const input = document.getElementById('tech-input');
        let val = parseFloat(input.value) || 0;
        val = Math.round((val + amount) * 10) / 10;
        if (val < 0) val = 0;
        if (val > 10) val = 10;
        input.value = val;
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
    <div class="mb-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="/manage/events"
                class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                <i class="ph-bold ph-arrow-left text-xl"></i>
            </a>
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">Ajout Rapide</h1>
                <p class="text-slate-500">Créez un événement complet avec plusieurs parcours.</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 md:p-8">
        <form action="/manage/unified/create" method="post" enctype="multipart/form-data" class="space-y-8"
            id="createForm">

            <!-- Event & Edition -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Nom de l'Événement</label>
                    <input type="text" name="event_name" placeholder="Ex: UTMB Mont-Blanc" required
                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                    <p class="text-xs text-slate-400 mt-1">S'il existe déjà, nous le réutiliserons.</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Année / Édition</label>
                    <input type="number" name="year" value="2025" required
                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
            </div>

            <!-- Images -->
            <div class="pt-6 border-t border-slate-50">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph-duotone ph-image text-brand-500"></i> Images
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Banner -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Bannière (Header)</label>
                        <div class="flex items-center justify-center w-full">
                            <label for="banner_file"
                                class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="ph-duotone ph-image text-3xl text-slate-400 mb-2"></i>
                                    <p class="text-xs text-slate-500 text-center px-2">Header / Bannière</p>
                                </div>
                                <input id="banner_file" name="banner_file" type="file" accept="image/*" class="hidden"
                                    onchange="showFilename(this, 'banner-display')" />
                            </label>
                        </div>
                        <p id="banner-display" class="text-xs text-brand-600 font-medium mt-2 text-center hidden"></p>
                    </div>

                    <!-- Profile -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Photo de Profil (Logo)</label>
                        <div class="flex items-center justify-center w-full">
                            <label for="profile_file"
                                class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="ph-duotone ph-user-circle text-3xl text-slate-400 mb-2"></i>
                                    <p class="text-xs text-slate-500 text-center px-2">Logo Carré</p>
                                </div>
                                <input id="profile_file" name="profile_file" type="file" accept="image/*" class="hidden"
                                    onchange="showFilename(this, 'profile-display')" />
                            </label>
                        </div>
                        <p id="profile-display" class="text-xs text-brand-600 font-medium mt-2 text-center hidden"></p>
                    </div>
                </div>
            </div>

            <!-- Routes Container -->
            <div class="pt-6 border-t border-slate-50">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph-duotone ph-path text-brand-500"></i> Parcours
                    </h3>
                    <button type="button" onclick="addRoute()"
                        class="text-sm px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-lg transition-colors flex items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Ajouter un parcours
                    </button>
                </div>

                <div id="routes-container" class="space-y-6">
                    <!-- Route 0 (Default) -->
                    <div class="route-item bg-slate-50 rounded-xl p-6 border border-slate-200 relative group transition-all hover:border-brand-200 hover:shadow-sm"
                        data-index="0">
                        <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            <!-- Delete Button (Hidden for first item via JS logic usually, but visible for consistency) -->
                            <button type="button" onclick="removeRoute(this)"
                                class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Nom
                                    du Parcours</label>
                                <input type="text" name="route_name_0" placeholder="Ex: OCC" required
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Catégorie</label>
                                <select name="distance_category_0"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                    <option value="">Sélectionner</option>
                                    <option value="20K">20K (XS-S)</option>
                                    <option value="50K">50K (M)</option>
                                    <option value="100K">100K (L)</option>
                                    <option value="100M">100M (XL)</option>
                                </select>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Fichier
                                    GPX (Optionnel)</label>
                                <input type="file" name="route_file_0" accept=".gpx"
                                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-6 flex justify-end">
                <button type="submit"
                    class="px-8 py-3 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700 transition-colors shadow-lg shadow-brand-500/30 w-full md:w-auto flex items-center justify-center gap-2">
                    <i class="ph-bold ph-check"></i> Créer les Parcours
                </button>
            </div>

        </form>
    </div>
</div>

<!-- Template for new routes -->
<template id="route-template">
    <div class="route-item bg-slate-50 rounded-xl p-6 border border-slate-200 relative group transition-all hover:border-brand-200 hover:shadow-sm"
        data-index="{index}">
        <div class="absolute top-4 right-4">
            <button type="button" onclick="removeRoute(this)"
                class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded" title="Supprimer">
                <i class="ph-bold ph-trash"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Nom du
                    Parcours</label>
                <input type="text" name="route_name_{index}" placeholder="Ex: CCC" required
                    class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none bg-white">
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Catégorie</label>
                <select name="distance_category_{index}"
                    class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                    <option value="">Sélectionner</option>
                    <option value="20K">20K</option>
                    <option value="50K">50K</option>
                    <option value="100K">100K</option>
                    <option value="100M">100M</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Fichier GPX
                    (Optionnel)</label>
                <input type="file" name="route_file_{index}" accept=".gpx"
                    class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100" />
            </div>
        </div>
    </div>
</template>

<script>
    function showFilename(input, displayId) {
        const display = document.getElementById(displayId);
        if (input.files && input.files[0]) {
            display.textContent = input.files[0].name;
            display.classList.remove('hidden');
        } else {
            display.classList.add('hidden');
        }
    }

    // Initialize index counter based on existing rows (1 normally)
    let routeIndex = 1;

    function addRoute() {
        const container = document.getElementById('routes-container');
        const template = document.getElementById('route-template').innerHTML;

        // Simple string replace for index placeholder
        const newHtml = template.replace(/{index}/g, routeIndex);

        // Create a temp div to parse HTML
        const div = document.createElement('div');
        div.innerHTML = newHtml;
        const newRow = div.firstElementChild;

        // Append
        container.appendChild(newRow);

        // Focus name input
        const nameInput = newRow.querySelector('input[type="text"]');
        if (nameInput) nameInput.focus();

        routeIndex++;
    }

    function removeRoute(btn) {
        // Find parent .route-item
        const row = btn.closest('.route-item');
        if (row) {
            // Check if it's the only one? Or let user delete all?
            // If deleting, notice that our backend loop depends on indices 0..N
            // If we delete 0 and keep 1, backend looks for 0, fails, and stops.
            // SOLUTION: We must RE-INDEX everything effectively on submit or ensure continuity.
            // EASIER: Just hide it and disable inputs?
            // BETTER: Re-index on remove.

            row.remove();
            reindexRoutes();
        }
    }

    function reindexRoutes() {
        const rows = document.querySelectorAll('.route-item');
        routeIndex = 0;
        rows.forEach(row => {
            // Update attributes and names
            row.setAttribute('data-index', routeIndex);

            // Update inputs
            const nameInput = row.querySelector('input[name^="route_name_"]');
            if (nameInput) nameInput.name = `route_name_${routeIndex}`;

            const catInput = row.querySelector('select[name^="distance_category_"]');
            if (catInput) catInput.name = `distance_category_${routeIndex}`;

            const fileInput = row.querySelector('input[name^="route_file_"]');
            if (fileInput) fileInput.name = `route_file_${routeIndex}`;

            routeIndex++;
        });
    }
</script>
{% endblock %}